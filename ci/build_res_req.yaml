steps:
  # Build new Docker image
  - id: "build"
    name: "gcr.io/cloud-builders/docker"
    args:
      - "build"
      - "-t"
      - "us-central1-docker.pkg.dev/$PROJECT_ID/res-req-registry/res-req:latest"
      - "-f"
      - "Dockerfile.res_req"
      - "."
  # Push new Docker image to registry
  - id: "push"
    name: "gcr.io/cloud-builders/docker"
    args:
      - "push"
      - "us-central1-docker.pkg.dev/$PROJECT_ID/res-req-registry/res-req:latest"
  # Deploy as Cloud Run job
  - id: "deploy"
    name: "gcr.io/google.com/cloudsdktool/cloud-sdk"
    entrypoint: "bash"
    args:
      - "-c"
      - |
        # Create the job if it doesn't exist (idempotent)
        gcloud run jobs describe res-req --region us-central1 || \
        gcloud run jobs create res-req-job \
          --image us-central1-docker.pkg.dev/$PROJECT_ID/res-req-registry/res-req:latest \
          --region us-central1
          
        # Update the job to point to the latest image
        gcloud run jobs update res-req-job \
          --image us-central1-docker.pkg.dev/$PROJECT_ID/res-req-registry/res-req:latest \
          --region us-central1

options:
  logging: CLOUD_LOGGING_ONLY
